<?xml version="1.0" encoding="UTF-8"?>
<script>
  <metadata>
    <priority>0</priority>
    <help/>
  </metadata>
  <code><![CDATA[/**
 * Code for the user editor object display
 * ----------------------------------------
 * This Script supports the display for user edit
 */


/**
 * DECLARATION SECTION
 */
var username, fullname, password, hash, language, defaultdisplay, contentdisplay, superuser, webmi, opcua, colid;
var keyboard = webMI.query["keyboard"];
var trigger_fullname = "com.atvise.user.fullname";
var trigger_password = "com.atvise.user.password";
var trigger_language = "com.atvise.user.language";
var trigger_display_default = "com.atvise.user.display_default";
var trigger_display_content = "com.atvise.user.display_content";
var trigger_superuser = "com.atvise.user.superuser";

function getData(username) {
	webMI.data.read(["SYSTEM.SECURITY.USERS." + username + ".name",
					"SYSTEM.SECURITY.USERS." + username + ".password",
					"SYSTEM.SECURITY.USERS." + username + ".language",
					"SYSTEM.SECURITY.USERS." + username + ".display_default",
					"SYSTEM.SECURITY.USERS." + username + ".display_content",
					"SYSTEM.SECURITY.USERS." + username + ".superuser",
					"SYSTEM.SECURITY.USERS." + username + ".login_opcua",
					"SYSTEM.SECURITY.USERS." + username + ".login_webmi"
					],
		function(e) {
			fullname = e[0].value;
			hash = e[1].value;	
			language = e[2].value;
			defaultdisplay = (e[3].value == "" || e[3].value == 0) ? "": e[3].value;
			contentdisplay = (e[4].value == "" || e[4].value == 0) ? "": e[4].value;
			superuser = (e[5].value == false ? 0 : 1);
			opcua = (e[6].value == false ? 0 : 1);
			webmi = (e[7].value == false ? 0 : 1);
			writeData();
	});
}

function writeData() {
	webMI.gfx.setText("username", username);
	webMI.trigger.fire("setValue", fullname, "fullname_input");
	//webMI.trigger.fire("setValue", hash, "password_input");
	webMI.trigger.fire("setValue", language, "language_input");
	webMI.trigger.fire("setChecked", superuser, "super_user");
	webMI.trigger.fire("setChecked", opcua, "opcua");
	webMI.trigger.fire("setChecked", webmi, "webmi");
	
	if (defaultdisplay.length > 25) {
		webMI.trigger.fire("setValue", "..." + defaultdisplay.substr(defaultdisplay.length - 23, 23), "display_default_input");
	} else {
		webMI.trigger.fire("setValue", defaultdisplay, "display_default_input");
	}
	
	if (contentdisplay.length > 25) {
		webMI.trigger.fire("setValue", "..." + contentdisplay.substr(contentdisplay.length - 23, 23),"display_content_input");
	} else {
		webMI.trigger.fire("setValue", contentdisplay, "display_content_input");
	}
}

function resetData() {
	webMI.gfx.setText("username", "T{Loading...}");
	webMI.trigger.fire("setValue", "", "fullname_input");
	webMI.trigger.fire("setValue", "", "password_input");
	webMI.trigger.fire("setValue", "", "language_input");
	webMI.trigger.fire("setValue", "","display_default_input");
	webMI.trigger.fire("setValue", "", "display_content_input");
	webMI.trigger.fire("setChecked", 0, "super_user");
	webMI.trigger.fire("setChecked", 0, "opcua");
	webMI.trigger.fire("setChecked", 0, "webmi");
	webMI.gfx.setText("error_message", "");
}

/**
 * RUNTIME SECTION
 * Runtime code has to be executed after onload to take care all other resources are ready
 */
webMI.addOnload(function() {
	resetData();
	
	webMI.addEvent(webMI.data, "clientvariableschange", function(e) {
		if(webMI.query.user && webMI.query.user != ""){
			username = webMI.query.user;
			colid = webMI.query.colid;
			getData(username);
		}
		else if (e.username && e.username != "") {
			username = e.username;
			getData(username);
		}
	});
});

/**
 * TRIGGER SECTION
 */
webMI.trigger.connect("clicked", function (e) {
	var password_error = false;
	webMI.gfx.setText("error_message", "");
			
	//put webMI login to the end of the callstack to receive correct data from triggers before
	setTimeout(function () {
		if (typeof username != "undefined" && username != "") {
			var data = {"mode": "Edit", "username": username, "fullname": fullname, "language": language, "defaultdisplay": defaultdisplay, "contentdisplay": contentdisplay, "superuser": superuser, "opcua": opcua, "webmi": webmi, "colid": colid};
				
			if (password != "")
				data["password"] = password;
			webMI.data.call("UserManagement", data, function(e) {
				if (e.error) {
					webMI.gfx.setFill("error_message", "#FF0000");
					webMI.gfx.setText("error_message", "T{Error}: T{Can't write user information and/or password.}");
					getData(username);
				} else {
					webMI.gfx.setFill("error_message", "#00c800");
					webMI.gfx.setText("error_message", "T{Changes saved successfully.}");
					webMI.display.closeWindow();
				}
				webMI.trigger.fire("edit_user", data);
			});
		} else {
				webMI.gfx.setFill("error_message", "#FF0000");
				webMI.gfx.setText("error_message", "T{Error}: T{User not logged in!}");
		}
	}, 0);
}, "save_button");
webMI.trigger.connect("clicked", function (e) {
	webMI.display.closeWindow();
	webMI.trigger.fire("edit_user", "");
}, "cancel_button");

webMI.trigger.connect("valuechanged", function (e) {
	fullname = e.value;
}, "fullname_input");

webMI.trigger.connect("valuechanged", function (e) {
	superuser = e.value;
}, "super_user");

webMI.trigger.connect("valuechanged", function (e) {
	opcua = e.value;
}, "opcua");

webMI.trigger.connect("valuechanged", function (e) {
	webmi = e.value;
}, "webmi");

webMI.trigger.connect("valuechanged", function (e) {
	defaultdisplay = e.value;
}, "display_default_input");

webMI.trigger.connect("valuechanged", function (e) {
	contentdisplay = e.value;
}, "display_content_input");

webMI.trigger.connect("valuechanged", function (e) {
	password = e.value;
}, "password_input");

webMI.trigger.connect("valuechanged", function (e) {
	language = e.value;
}, "language_input");

webMI.trigger.connect(trigger_password, function (e) {
	password = e.value;
	webMI.trigger.fire("setValue", e.value, "password_input");
});

webMI.trigger.connect(trigger_fullname, function (e) {
	fullname = e.value;
	webMI.trigger.fire("setValue", e.value, "fullname_input");
});

webMI.trigger.connect(trigger_display_default, function (e) {
	defaultdisplay = e.value;
	webMI.trigger.fire("setValue", e.value, "display_default_input");
});

webMI.trigger.connect(trigger_display_content, function (e) {
	contentdisplay = e.value;
	webMI.trigger.fire("setValue", e.value, "display_content_input");
});

webMI.trigger.connect(trigger_language, function (e) {
	language = e.value;
	webMI.trigger.fire("setValue", e.value, "language_input");
});

webMI.trigger.connect("clicked", function (e) {
	webMI.query.trigger = trigger_fullname;
	webMI.query.password = "No";
	webMI.query.value = fullname;
	webMI.display.openWindow({
		display: keyboard,
		extern: false,
		height: 300,
		menubar: false,
		modal: true,
		movable: true,
		resizable: false,
		scrollbars: false,
		status: false,
		title: "T{Keyboard}",
		toolbar: false,
		width: 700,
		query: webMI.query
	});
}, "fullname_keyboard");

webMI.trigger.connect("clicked", function (e) {
	webMI.query.trigger = trigger_display_default;
	webMI.query.password = "No";
	webMI.query.value = defaultdisplay;
	webMI.display.openWindow({
		display: keyboard,
		extern: false,
		height: 300,
		menubar: false,
		modal: true,
		movable: true,
		resizable: false,
		scrollbars: false,
		status: false,
		title: "T{Keyboard}",
		toolbar: false,
		width: 700,
		query: webMI.query
	});
}, "display_default_keyboard");

webMI.trigger.connect("clicked", function (e) {
	webMI.query.trigger = trigger_display_content;
	webMI.query.password = "No";
	webMI.query.value = contentdisplay;
	webMI.display.openWindow({
		display: keyboard,
		extern: false,
		height: 300,
		menubar: false,
		modal: true,
		movable: true,
		resizable: false,
		scrollbars: false,
		status: false,
		title: "T{Keyboard}",
		toolbar: false,
		width: 700,
		query: webMI.query
	});
}, "display_content_keyboard");

webMI.trigger.connect("clicked", function (e) {
	webMI.query.trigger = trigger_language;
	webMI.query.password = "No";
	webMI.query.value = "";
	webMI.display.openWindow({
		display: keyboard,
		extern: false,
		height: 300,
		menubar: false,
		modal: true,
		movable: true,
		resizable: false,
		scrollbars: false,
		status: false,
		title: "T{Keyboard}",
		toolbar: false,
		width: 700,
		query: webMI.query
	});
}, "language_keyboard");

webMI.trigger.connect("clicked", function (e) {
	webMI.query.trigger = trigger_password;
	webMI.query.password = "Yes";
	webMI.query.value = "";
	webMI.display.openWindow({
		display: keyboard,
		extern: false,
		height: 300,
		menubar: false,
		modal: true,
		movable: true,
		resizable: false,
		scrollbars: false,
		status: false,
		title: "T{Keyboard}",
		toolbar: false,
		width: 700,
		query: webMI.query
	});
}, "password_keyboard");]]></code>
</script>
