<?xml version="1.0" encoding="UTF-8"?>
<script>
  <metadata>
    <priority>0</priority>
    <help/>
  </metadata>
  <code><![CDATA[/**
 * Code for the user add object display
 * ----------------------------------------
 * This Script supports the display for user add
 */


/**
 * DECLARATION SECTION
 */
var username, fullname, password, hash, language, defaultdisplay, contentdisplay, superuser, opcua, webmi, colid;
var keyboard = webMI.query["keyboard"];
var trigger_username = "com.atvise.user.username";
var trigger_fullname = "com.atvise.user.fullname";
var trigger_password = "com.atvise.user.password";
var trigger_language = "com.atvise.user.language";
var trigger_display_default = "com.atvise.user.display_default";
var trigger_display_content = "com.atvise.user.display_content";
var trigger_superuser = "com.atvise.user.superuser";

function resetData() {
	webMI.gfx.setText("username", "T{Please login!}");
	webMI.trigger.fire("setValue", "", "fullname_input");
	webMI.trigger.fire("setValue", "", "password_input");
	webMI.trigger.fire("setValue", "", "language_input");
	webMI.trigger.fire("setValue", "","display_default_input");
	webMI.trigger.fire("setValue", "", "display_content_input");
	webMI.trigger.fire("setChecked", 0, "super_user");
	webMI.trigger.fire("valuechanged", 0, "super_user");
	webMI.trigger.fire("setChecked", 0, "opcua");
	webMI.trigger.fire("valuechanged", 0, "opcua");
	webMI.trigger.fire("setChecked", 0, "webmi");
	webMI.trigger.fire("valuechanged", 0, "webmi");
	webMI.gfx.setText("error_message", "");
}

/**
 * RUNTIME SECTION
 * Runtime code has to be executed after onload to take care all other resources are ready
 */
webMI.addOnload(function() {
	resetData();
});

/**
 * TRIGGER SECTION
 */
webMI.trigger.connect("clicked", function (e) {
	var password_error = false;
	webMI.gfx.setText("error_message", "");
	
	//put webMI login to the end of the callstack to receive correct data from triggers before
	setTimeout(function () {
		if (typeof username != "undefined" && username != "") {
			var data = {"mode": "Add", "username": username, "fullname": fullname, "language": language, "defaultdisplay": defaultdisplay, "contentdisplay": contentdisplay, "superuser": superuser, "opcua": opcua, "webmi": webmi, "colid": colid};
			if (password != "")
				data["password"] = password;
				webMI.data.call("UserManagement", data, function(e) {
					if (e.error) {
						webMI.gfx.setFill("error_message", "#FF0000");
						webMI.gfx.setText("error_message", "T{Error}: T{"+e.error+"}");
					} else {
						webMI.gfx.setFill("error_message", "#00c800");
						webMI.gfx.setText("error_message", "T{Changes saved successfully.}");
						webMI.trigger.fire("add_user", data);
						webMI.display.closeWindow();
					}
					
					
				});
		} else {
				webMI.gfx.setFill("error_message", "#FF0000");
				webMI.gfx.setText("error_message", "T{Error}: T{Please enter username!}");
		}
	}, 0);
}, "save_button");
webMI.trigger.connect("clicked", function (e) {
	webMI.display.closeWindow();
	webMI.trigger.fire("add_user", "");
}, "cancel_button");

webMI.trigger.connect("valuechanged", function (e) {
	username = e.value;
}, "username_input");

webMI.trigger.connect("valuechanged", function (e) {
	fullname = e.value;
}, "fullname_input");

webMI.trigger.connect("valuechanged", function (e) {
	superuser = e.value;
}, "super_user");

webMI.trigger.connect("valuechanged", function (e) {
	opcua = e.value;
}, "opcua");

webMI.trigger.connect("valuechanged", function (e) {
	webmi = e.value;
}, "webmi");

webMI.trigger.connect("valuechanged", function (e) {
	defaultdisplay = e.value;
}, "display_default_input");

webMI.trigger.connect("valuechanged", function (e) {
	contentdisplay = e.value;
}, "display_content_input");

webMI.trigger.connect("valuechanged", function (e) {
	password = e.value;
}, "password_input");

webMI.trigger.connect("valuechanged", function (e) {
	language = e.value;
}, "language_input");

webMI.trigger.connect(trigger_username, function (e) {
	username = e.value;
	webMI.trigger.fire("setValue", e.value, "username_input");
});

webMI.trigger.connect(trigger_password, function (e) {
	password = e.value;
	webMI.trigger.fire("setValue", e.value, "password_input");
});

webMI.trigger.connect(trigger_fullname, function (e) {
	fullname = e.value;
	webMI.trigger.fire("setValue", e.value, "fullname_input");
});

webMI.trigger.connect(trigger_display_default, function (e) {
	defaultdisplay = e.value;
	webMI.trigger.fire("setValue", e.value, "display_default_input");
});

webMI.trigger.connect(trigger_display_content, function (e) {
	contentdisplay = e.value;
	webMI.trigger.fire("setValue", e.value, "display_content_input");
});

webMI.trigger.connect(trigger_language, function (e) {
	language = e.value;
	webMI.trigger.fire("setValue", e.value, "language_input");
});

webMI.trigger.connect("clicked", function (e) {
	webMI.query.trigger = trigger_username;
	webMI.query.password = "No";
	webMI.query.value = username;
	webMI.display.openWindow({
		display: keyboard,
		extern: false,
		height: 300,
		menubar: false,
		modal: true,
		movable: true,
		resizable: false,
		scrollbars: false,
		status: false,
		title: "T{Keyboard}",
		toolbar: false,
		width: 700,
		query: webMI.query
	});
}, "username_keyboard");

webMI.trigger.connect("clicked", function (e) {
	webMI.query.trigger = trigger_fullname;
	webMI.query.password = "No";
	webMI.query.value = fullname;
	webMI.display.openWindow({
		display: keyboard,
		extern: false,
		height: 300,
		menubar: false,
		modal: true,
		movable: true,
		resizable: false,
		scrollbars: false,
		status: false,
		title: "T{Keyboard}",
		toolbar: false,
		width: 700,
		query: webMI.query
	});
}, "fullname_keyboard");

webMI.trigger.connect("clicked", function (e) {
	webMI.query.trigger = trigger_display_default;
	webMI.query.password = "No";
	webMI.query.value = defaultdisplay;
	webMI.display.openWindow({
		display: keyboard,
		extern: false,
		height: 300,
		menubar: false,
		modal: true,
		movable: true,
		resizable: false,
		scrollbars: false,
		status: false,
		title: "T{Keyboard}",
		toolbar: false,
		width: 700,
		query: webMI.query
	});
}, "display_default_keyboard");

webMI.trigger.connect("clicked", function (e) {
	webMI.query.trigger = trigger_display_content;
	webMI.query.password = "No";
	webMI.query.value = contentdisplay;
	webMI.display.openWindow({
		display: keyboard,
		extern: false,
		height: 300,
		menubar: false,
		modal: true,
		movable: true,
		resizable: false,
		scrollbars: false,
		status: false,
		title: "T{Keyboard}",
		toolbar: false,
		width: 700,
		query: webMI.query
	});
}, "display_content_keyboard");

webMI.trigger.connect("clicked", function (e) {
	webMI.query.trigger = trigger_language;
	webMI.query.password = "No";
	webMI.query.value = "";
	webMI.display.openWindow({
		display: keyboard,
		extern: false,
		height: 300,
		menubar: false,
		modal: true,
		movable: true,
		resizable: false,
		scrollbars: false,
		status: false,
		title: "T{Keyboard}",
		toolbar: false,
		width: 700,
		query: webMI.query
	});
}, "language_keyboard");

webMI.trigger.connect("clicked", function (e) {
	webMI.query.trigger = trigger_password;
	webMI.query.password = "Yes";
	webMI.query.value = "";
	webMI.display.openWindow({
		display: keyboard,
		extern: false,
		height: 300,
		menubar: false,
		modal: true,
		movable: true,
		resizable: false,
		scrollbars: false,
		status: false,
		title: "T{Keyboard}",
		toolbar: false,
		width: 700,
		query: webMI.query
	});
}, "password_keyboard");]]></code>
</script>
