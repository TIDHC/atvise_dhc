<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<svg height="890" version="1.2" width="960" xmlns="http://www.w3.org/2000/svg" xmlns:atv="http://webmi.atvise.com/2007/svgext" xmlns:xlink="http://www.w3.org/1999/xlink">
 <defs/>
 <metadata>
  <atv:gridconfig enabled="false" gridstyle="lines" height="20" width="20"/>
  <atv:snapconfig enabled="true" height="1" width="1"/>
 </metadata>
 <g atv:insensitive="true" atv:refpx="0" atv:refpy="0" id="id_11" transform="matrix(0.7499,0,0,1.159,0,0)">
  <rect atv:refpx="640" atv:refpy="384" fill="#ffffff" height="768.00" id="id_12" width="1280.00" x="0" y="0"/>
 </g>
 <g atv:refpx="787" atv:refpy="315.5" id="id_5" transform="matrix(1,0,0,1,210,-452)">
  <polyline atv:refpx="586.5" atv:refpy="785.5" fill="#000018" fill-opacity="0" id="id_9" points="557,747 557,824 616,824 616,824" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-opacity="0.956863" stroke-width="6"/>
  <polygon atv:refpx="1406" atv:refpy="741.501" fill="#000018" id="id_15" points="538,754 574,754 556,729 556,729" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-opacity="0" stroke-width="2.015"/>
 </g>
 <svg atv:refpx="766.063" atv:refpy="150.008" height="63.11" id="id_1" transform="matrix(1.5038,0,0,1.4578,0,0)" width="133" x="442.883" xlink:href="ObjectTypes.PROJECT.ElementoLinea.Principal" y="71.349">
  <atv:argument name="base" value="AGENT.OBJECTS.SCADA.Solidaridad.Circuitos.Circuito_PA.Carcamo_014"/>
 </svg>
 <svg atv:refpx="769.071" atv:refpy="365.009" height="63.11" id="id_2" transform="matrix(1.5038,0,0,1.4578,0,0)" width="133" x="444.883" xlink:href="ObjectTypes.PROJECT.ElementoLinea.Principal" y="218.833">
  <atv:argument name="base" value="AGENT.OBJECTS.SCADA.Solidaridad.Circuitos.Circuito_PA.Desaladora_Puerto_Maya"/>
 </svg>
 <text atv:refpx="313.974" atv:refpy="53.62" fill="#000018" font-family="Arial" font-size="50" font-weight="bold" id="id_106" transform="matrix(0.612,0,0,0.6329,17.46,12.4814)" x="50" y="86">CIRCUITO DE AGUA POTABLE</text>
 <text atv:refpx="239.31" atv:refpy="115.62" fill="#000018" font-family="Arial" font-size="50" font-weight="bold" id="id_8" transform="matrix(0.612,0,0,0.6329,17.46,35.2416)" x="50" y="148">PUERTO AVENTURAS</text>
 <svg atv:refpx="153.01" atv:refpy="329.995" height="63.11" id="id_0" transform="matrix(1.5038,0,0,1.4578,0,0)" width="133" x="35.245" xlink:href="ObjectTypes.PROJECT.ElementoLinea.Principal" y="190.698">
  <atv:argument name="base" value="AGENT.OBJECTS.SCADA.Solidaridad.Circuitos.Circuito_PA.Carcamo_013"/>
 </svg>
 <foreignObject height="447" id="mapa" width="959" x="0" y="440">
  <div style="width:100%;height:100%" xmlns="http://www.w3.org/1999/xhtml"/>
 </foreignObject>
 <svg atv:refpx="152" atv:refpy="441.012" height="23" id="id_6" transform="matrix(2,0,0,1.8261,0,0)" width="100" x="26" xlink:href="ObjectTypes.PROJECT.Caudalimetro.line_mini" y="202.079">
  <atv:argument name="base" value="AGENT.OBJECTS.SCADA.Solidaridad.Zona_Urbana.Carcamos_AP.AP_SOL_CAR_13.Caudalimetro.L1"/>
 </svg>
 <svg atv:refpx="766.01" atv:refpy="216" height="23" id="id_7" transform="matrix(2.02,0,0,1.6522,0,0)" width="100" x="329.214" xlink:href="ObjectTypes.PROJECT.Caudalimetro.line_mini" y="119.241">
  <atv:argument name="base" value="AGENT.OBJECTS.SCADA.Solidaridad.Zona_Urbana.Carcamos_AP.AP_SOL_CAR_14.Caudalimetro.L1"/>
 </svg>
 <svg atv:refpx="766.01" atv:refpy="253.5" height="23" id="id_16" transform="matrix(2,0,0,1.6957,0,0)" width="100" x="333.005" xlink:href="ObjectTypes.PROJECT.Caudalimetro.line_mini" y="138.008">
  <atv:argument name="base" value="AGENT.OBJECTS.SCADA.Solidaridad.Zona_Urbana.Carcamos_AP.AP_SOL_CAR_14.Caudalimetro.LE_1"/>
 </svg>
 <script atv:desc="" atv:name="" type="text/ecmascript"><![CDATA[//----------------Inicializo variables -------------------//


//Variable interna
var Info_Windowact=false;
var Markeract=false;
var Markeractdc;
var Markers= new Array();
var Rutas= new Array();
var Pos_origen;
var Pos_destination;
var WayPoints = new Array();

var google = webMI.rootWindow.google; //Clase Principal
var map; //Variable donde va a vivir el mapa
var m,n;
var circuito =
	[[20.510511080148984, -87.23237643858741],
	 [20.513718430463125, -87.22912772988185],
	 [20.51365437978025, -87.22885857272563]]

					
var circuito_s =
	[[{lat:20.510511080148984, lng:-87.23237643858741},
	"Cárcamo 13, Agua Potable",
	"AGENT.OBJECTS.SCADA.Solidaridad.Circuitos.Circuito_PA.Carcamo_013",
	1, "startpoint"],
	[{lat:20.513718430463125, lng:-87.22912772988185},
	"Cárcamo 14, Agua Potable",
	"AGENT.OBJECTS.SCADA.Solidaridad.Circuitos.Circuito_PA.Carcamo_014",
	2, "midpoint"],
	[{lat:20.51365437978025, lng:-87.22885857272563},
	"Desaladora Puerto Aventuras, Agua Potable",
	"AGENT.OBJECTS.SCADA.Solidaridad.Circuitos.Circuito_PA.Desaladora_Puerto_Maya",
	3, "endpoint"]];
					
var infowindow;					
var circuito_centro;
const symbolSofrel = "/icons/carcamo_31_40px.png";



//----------------Ejecución -------------------//



//Determinación del dispositivo
var infoCliente;
infoCliente = new webMI.getClientInfo();

//Preprocesamiento de variables

//Calculo del Centro
var suma=[0,0];
for (var i=0; i<circuito.length; i++){
	suma[0]=suma[0]+circuito[i][0]; //Latitud 
	suma[1]=suma[1]+circuito[i][1]; //Longitud
}

circuito_centro=[suma[0]/circuito.length,suma[1]/circuito.length];


webMI.addOnload(function() {
	
	//Posiciones en el mapa
	var position1 = new google.maps.LatLng(circuito_centro[0], circuito_centro[1]);
	
	//Opciones del mapa
	var myOptions = {
		zoom: 15,
		center: position1,
		mapTypeId: google.maps.MapTypeId.roadmap
	};
	

	//Inicializo el mapa
	map = new google.maps.Map(document.getElementById("mapa"), myOptions);
	
	
		
	
		
	// Instantiate an info window to hold step text.
	const stepDisplay = new google.maps.InfoWindow();
	
	
	//-------Inicializo Marcadores
	
	circuito_s.forEach(([position,title,object,order,type],i) =>{
		const marker = new google.maps.Marker({
			position, 
			map,
			icon: symbolSofrel,
			title: ` ${order}`,
			optimized: false,
		});
		
		marker.setMap(map);
		
		//Agrego marcador a lista de marcadores
		Markers.push(marker);
	
		//-------Listener de Marcadores
		
		//DOBLECLICK (Fija Carcamo)
			//DOBLECLICK (Fija Carcamo)
		google.maps.event.addListener(marker,'dblclick',function(event) {		

			webMI.display.openWindow({display:"SYSTEM.DISPLAYS.Circuito.Eslabon",
			extern:false,height:610,menubar:false,modal:false,movable:true,
			resizable:true,scrollbars:false,status:false,title:title,
			toolbar:false,width:600,x:0,y:50,query:{base:   object}});

			map.panTo(this.getPosition());
			map.setZoom(15);

			Markeract=true;
			Markeractdc=marker;
			Pos_origen=position;
		
			
			//Limpio
			Elimina_Ruta(Rutas);
				
		});
	/*	map.addListener("zoom_changed", () => {
    infowindow.setContent("Zoom: " + map.getZoom());
  });*/
		
		
		//CLICK (Abre Infowindow)
		/*google.maps.event.addListener(marker,'click',function(event) {	
			
			//Abro en temporal
			if (marker!=Markeractdc && Markeract==true ){		
				webMI.display.openDisplay("ObjectTypes.PROJECT.DataLogger"+ type +".Grafico_SectorizacionB", {base:  "AGENT.OBJECTS.Sofrel." + object}, "SectorizacionB");
				Pos_destination=position;	
				
				//Limpio
				Elimina_Ruta(Rutas);
				
				//Dibujo
				//Dibuja_Ruta(Pos_origen,Pos_destination);
			}
			
			//webMI.display.openDisplay("SYSTEM.LIBRARY.PROJECT.OBJECTDISPLAYS.LAYOUTS.Blanc_Layout",{}, "detallesCarcamoNext");
			
		});	*/
			
		
		//MOUSEOVER
		google.maps.event.addListener(marker, "mouseover", function(event){
			infowindow = new google.maps.InfoWindow();
			//Abro marcador
			infowindow.open(marker.getMap,marker);
			Info_Windowact=true;
			//Defino que objeto va a ser el seleccionado para mostrar su información
			webMI.data.subscribe( object +".pressure",
			function(e){
				infowindow.setContent(title+" - Presión: " +
				e.value.toFixed(2) + "kg/cm2");
				}
			);
			
				//infowindow.setContent(title);
		
		});	
		
		//MOUSEOUT
		google.maps.event.addListener(marker, "mouseout", function(event){
			
			
			if (Info_Windowact){
				infowindow.close();
				Info_Windowact=false;
			}			
		});
		
		
		
	});	
			
});



function Dibuja_Ruta(Origen,Destination){
	
	if(Markeract && (Origen!=Destination)){
			
		//////////// Servicios Rutas en el mapa
		var directionsService = new google.maps.DirectionsService();
		var directionsRenderer = new google.maps.DirectionsRenderer({ map: map });		
		
		//Crea el request
		var request = {
			origin: Origen,
			destination:Destination,
			travelMode: google.maps.TravelMode.DRIVING // Puedes ajustar el modo de transporte según tus necesidades
		  };    
		
		
		directionsService.route(request, function(response, status) {
			if (status == google.maps.DirectionsStatus.OK) {
			  directionsRenderer.setDirections(response);
			  Rutas.push(directionsRenderer);
			}
		  });
	 }
    
 }


function Elimina_Ruta(Rutas){
	
	Rutas.forEach(function(ruta) {
		ruta.setMap(null);
	});
	
	Rutas=new Array();
    
 }]]></script>
</svg>
