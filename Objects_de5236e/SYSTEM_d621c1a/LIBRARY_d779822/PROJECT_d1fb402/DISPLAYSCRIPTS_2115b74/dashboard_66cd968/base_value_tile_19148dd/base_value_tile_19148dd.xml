<?xml version="1.0" encoding="UTF-8"?>
<script>
  <metadata>
    <priority>0</priority>
  </metadata>
  <code><![CDATA[

/**
 * Code for the base value tile object display
 * ----------------------------------------
 * This script supports the functions of the value dashboard tile.
 */


/**
 * DECLARATION SECTION
 */
var base = webMI.query["base"];

/** internal ids **/
var BACKGROUND_ID = "background";
var BLINKING_FRAME_ID = "blinking_frame";
var CLICKAREA_ID = "clickarea_display";
var MAIN_LABEL_ID = "main_label";
var SUB_LABEL_ID = "sub_label";
var TITLE_ID = "title";
var TITLEAREA_ID = "clickarea_title";
var UNIT_LABEL_ID = "unit_label";
var VALUE_LABEL_ID = "value_label";
var VALUE_UNIT_LABEL_ID = "value_unit_label";

/** interal visu setting **/
var BLINKING_FRAME_COLOR_ACTIVE = "#ffffff";
var BLINKING_FRAME_COLOR_INACTIVE = webMI.query["backgroundColor"];
webMI.gfx.setStroke(BLINKING_FRAME_ID, BLINKING_FRAME_COLOR_INACTIVE);

/** format output **/
var unit = webMI.query["unit"] || "";
var numberMode = webMI.query["outputMode"] === "number";
var precision = parseInt(webMI.query["postDecimals"], 10);
var oneLine = webMI.query["oneLine"] == "true" ? true : false;

/** click behavior **/
var contentFrame = webMI.query["contentFrame"] != "" ? webMI.query["contentFrame"] : "content_iframe_myframe";
var display = webMI.query["display"];
var enableClick = webMI.query["enableClick"] == "true" ? true : false;
var enableClickContent = webMI.query["enableClickContent"] == "true" ? true : false;
var enableElementID = webMI.query["linkedElementID"];

/** notifications **/
var alarmAddress = webMI.query["alarm"];
var statusEnabled = webMI.query["statusEnabled"];
var statusTrigger = webMI.query["statusTrigger"];

/** appearance **/
var alarmIndication = webMI.query["alarmIndication"];
var backgroundColor = webMI.query["backgroundColor"];
var colorInactive = webMI.query["colorInactive"];
var statusIndication = webMI.query["statusIndication"];

/** options **/
var tooltip = webMI.query["tooltip"];
if (tooltip) {
	webMI.callExtension("SYSTEM.LIBRARY.ATVISE.QUICKDYNAMICS.Tooltip", {
		"auto": "true",
		"id": TITLEAREA_ID,
		"text": tooltip
	});
}

/** rights **/
var right = webMI.query["right"] || "";
var activeNode = webMI.query["activeNode"] || "";
var activeValue = webMI.query["activeValue"] || "";

/** data **/
var runTimeNodeConfig = {
	base: {value: null, address: base, paramValue: "", read: true, write: false, aggregate: false}
};

/** advanced menu layout with corrections **/
var menuLayout = {
	customElementPosition: webMI.query["elementPosition"],
	customFadeInAtHover: webMI.query["fadeInAtHover"],
	customElementOffsetX: webMI.query["elementOffsetX"],
	customElementOffsetY: webMI.query["elementOffsetY"],
	customClickareaEnlargement: webMI.query["clickareaEnlargement"],
	customElementLayoutOffsets: {}
}


/**
 * RUNTIME SECTION
 */
if (typeof activationTriggerHandling === "function") activationTriggerHandling("com.atvise.setActive");

if (true) {
	var notifierConfig = {
		id: document.getElementById("background").id,
		rights: [
			{nodeId: webMI.query["base"], rights: "read", disable: true, notify: false},
			{nodeId: webMI.query["alarm"], rights: "alarmRead", disable: false, notify: true},
			{nodeId: webMI.query["activeNode"], rights: "read", disable: true, notify: true},
			{nodeId: webMI.query["display"], rights: "read", disable: false, notify: true}
		],
		menuLayout: menuLayout
	};

	var rightsHandlingProperties = {
		activationNodeSet: {activeNode: webMI.query["activeNode"], activeValue: webMI.query["activeValue"]},
		notifierConfiguration: webMI.query.displayAcNotification === "true" ? notifierConfig : {},
		userRight: webMI.query["right"],
		editable: true
	};

	if (typeof rightsHandling === "function")
		rightsHandling(rightsHandlingProperties);

	if (typeof updateRunTimeNodeConfig === "function") {
		updateRunTimeNodeConfig(runTimeNodeConfig, notifierConfig.rights, initialize);
	} else {
		initialize(runTimeNodeConfig)
	}
}


/**
 * FUNCTION SECTION
 */

/**
 * read or subscribe data by runtime node configuration
 * @param nodeCfg
 */
function initialize(nodeCfg) {
	if (alarmAddress != "")
		updateAlarmIndication(alarmAddress);

	if (nodeCfg.base.address && nodeCfg.base.read) {
		webMI.data.subscribe(webMI.query["base"], function (node) {
			var value = node.value;

			if (typeof node.status != "undefined" && typeof updateStatusIndication === "function") {
				updateStatusIndication(node.status);
			}

			if (numberMode) {
				precision = precision < 0 ? 0 : precision;
				precision = precision > 100 ? 100 : precision;
				value = value.toFixed(precision);
			}

			webMI.gfx.setText(VALUE_LABEL_ID, typeof value != "undefined" ? value : "");
			webMI.gfx.setText(VALUE_UNIT_LABEL_ID, (typeof value != "undefined" ? value : "") + " " + (unit ? unit : ""));
			webMI.gfx.setText(UNIT_LABEL_ID, unit ? unit : "");
		});
	} else {
		setInactiveLayout();
	}

	if(enableElementID) {
		try {
			var frame = webMI.rootWindow.document.getElementById(contentFrame);
			var element = frame.contentDocument.getElementById(enableElementID);

			if (!element) {
				setInactiveLayout();
			}
		} catch (ex) {
			setInactiveLayout();
		}
	}
}

/**
 * Activate display
 */
function setActiveLayout() {
	webMI.gfx.setText(TITLE_ID, webMI.query["title"]);

	webMI.gfx.setVisible(MAIN_LABEL_ID, false);
	webMI.gfx.setVisible(SUB_LABEL_ID, false);
	if (oneLine) {
		webMI.gfx.setVisible(VALUE_UNIT_LABEL_ID, null);
	} else {
		webMI.gfx.setVisible(VALUE_LABEL_ID, null);
		webMI.gfx.setVisible(UNIT_LABEL_ID, null);
	}
	webMI.gfx.setStroke(BLINKING_FRAME_ID, null);
	webMI.gfx.setFill(BACKGROUND_ID, backgroundColor);
	webMI.gfx.setFill(BLINKING_FRAME_ID, BLINKING_FRAME_COLOR_ACTIVE);

	enableClick = webMI.query["enableClick"] == "true" ? true : false;
	enableClickContent = webMI.query["enableClickContent"] == "true" ? true : false;
	enableElementID = webMI.query["linkedElementID"];
}

/**
 * Deactivate display
 */
function setInactiveLayout() {
	// webMI.gfx.setText(TITLE_ID, webMI.query["title"] + " (T{inactive})");
	webMI.gfx.setText(TITLE_ID, webMI.query["title"]);

	webMI.gfx.setVisible(MAIN_LABEL_ID, false);
	webMI.gfx.setVisible(SUB_LABEL_ID, false);

	webMI.gfx.setVisible(VALUE_LABEL_ID, false);
	webMI.gfx.setVisible(VALUE_UNIT_LABEL_ID, false);
	webMI.gfx.setVisible(UNIT_LABEL_ID, false);

	webMI.gfx.setFill(BACKGROUND_ID, colorInactive);
	webMI.gfx.setFill(BLINKING_FRAME_ID, colorInactive);
	webMI.gfx.setStroke(BLINKING_FRAME_ID, BLINKING_FRAME_COLOR_INACTIVE);

	enableClick = false;
	enableClickContent = false;
	enableElementID = false;
}


/**
 * EVENT SECTION
 */
if (display && enableClick) {
	webMI.addEvent(TITLEAREA_ID, ["click", "touchend"], function (e) {
		webMI.display.openDisplay(display);
	});
}

if (display && enableClickContent) {
	webMI.addEvent(CLICKAREA_ID, ["click", "touchend"], function (e) {
		webMI.display.openDisplay(display);
	});
}

if (enableElementID) {
	var frame = webMI.rootWindow.document.getElementById(contentFrame);
	var element = frame.contentDocument.getElementById(enableElementID);
	webMI.addEvent(element, ["click", "touchend"], function (e) {
		if (display && enableClick) {
			webMI.display.openDisplay(display);
		}
	});
}

]]></code>
</script>
