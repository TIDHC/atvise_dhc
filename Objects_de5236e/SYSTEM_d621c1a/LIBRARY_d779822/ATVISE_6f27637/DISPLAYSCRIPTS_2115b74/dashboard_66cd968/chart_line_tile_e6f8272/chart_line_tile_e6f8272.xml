<?xml version="1.0" encoding="UTF-8"?>
<script>
  <metadata>
    <priority>0</priority>
  </metadata>
  <code><![CDATA[/**
 * Code for the chart line tile object display
 * ----------------------------------------
 * This script supports the functions of the chart dashboard tile.
 */


/**
 * DECLARATION SECTION
 */
var base = webMI.query["base"];
var trendName = webMI.query["trendName"];

/** internal ids **/
var BACKGROUND_ID = "background";
var BLINKING_FRAME_ID = "blinking_frame";
var CHART_ID = "chart";
var CLICKAREA_ID = "clickarea_display";
var HIGHCHARTS_CONTAINER_SUFFIX = "_highcharts_container";
var MAIN_LABEL_ID = "main_label";
var TITLE_ID = "title";
var TITLEAREA_ID = "clickarea_title";
var SUB_LABEL_ID = "sub_label";

/** interal visu setting **/
var BLINKING_FRAME_COLOR_ACTIVE = "#ffffff";
var BLINKING_FRAME_COLOR_INACTIVE = webMI.query["backgroundColor"];
webMI.gfx.setStroke(BLINKING_FRAME_ID, BLINKING_FRAME_COLOR_INACTIVE);

/** format output **/
var oneLine = webMI.query["oneLine"] == "true" ? true : false;

/** click behavior **/
var contentFrame = webMI.query["contentFrame"] != "" ? webMI.query["contentFrame"] : "content_iframe_myframe";
var display = webMI.query["display"];
var enableClick = webMI.query["enableClick"] == "true" ? true : false;
var enableClickContent = webMI.query["enableClickContent"] == "true" ? true : false;
var enableElementID = webMI.query["linkedElementID"];

/** notifications **/
var alarmAddress = webMI.query["alarm"];
var statusEnabled = webMI.query["statusEnabled"];
var statusTrigger = webMI.query["statusTrigger"];

/** appearance **/
var alarmIndication = webMI.query["alarmIndication"];
var colorInactive = webMI.query["colorInactive"];
var backgroundColor = webMI.query["backgroundColor"];
var statusIndication = webMI.query["statusIndication"];

/** options **/
var tooltip = webMI.query["tooltip"];
if (tooltip) {
	webMI.callExtension("SYSTEM.LIBRARY.ATVISE.QUICKDYNAMICS.Tooltip", {
		"auto": "true",
		"id": TITLEAREA_ID,
		"text": tooltip
	});
}

/** data **/
var runTimeNodeConfig = {};
for (var s = 1; s < 16; s++) {
	var seriesAddress = "series" + s + "series_address";
	if (webMI.query[seriesAddress]) {
		runTimeNodeConfig[seriesAddress] =
			{
				value: null,
				address: webMI.query[seriesAddress],
				paramValue: "",
				read: true,
				write: false,
				aggregate: false
			}
	} else {
		break;
	}
}

/** advanced menu layout with corrections **/
var menuLayout = {
	customElementPosition: webMI.query["elementPosition"],
	customFadeInAtHover: webMI.query["fadeInAtHover"],
	customElementOffsetX: webMI.query["elementOffsetX"],
	customElementOffsetY: webMI.query["elementOffsetY"],
	customClickareaEnlargement: webMI.query["clickareaEnlargement"],
	customElementLayoutOffsets: {}
}

/**
 * RUNTIME SECTION
 */
if (typeof activationTriggerHandling === "function") activationTriggerHandling("com.atvise.setActive");

if (true) {
	var notifierConfig = {
		id: document.getElementById("background").id,
		rights: [
			{nodeId: webMI.query["alarm"], rights: "alarmRead", disable: false, notify: true},
			{nodeId: webMI.query["activeNode"], rights: "read", disable: true, notify: true},
			{nodeId: webMI.query["display"], rights: "read", disable: false, notify: true},
			{nodeId: webMI.query["gatviseOptions_configNode"], rights: "read", disable: true, notify: true}
		],
		menuLayout: menuLayout
	};

	for (var s = 1; s < 16; s++) {
		var seriesAddress = "series" + s + "series_address";
		if (webMI.query[seriesAddress]) {
			notifierConfig.rights.push(
				{
					nodeId: webMI.query[seriesAddress],
					rights: "read", disable: false, notify: false
				}
			);
		} else {
			break;
		}
	}

	var rightsHandlingProperties = {
		activationNodeSet: {activeNode: webMI.query["activeNode"], activeValue: webMI.query["activeValue"]},
		notifierConfiguration: webMI.query.displayAcNotification === "true" ? notifierConfig : {},
		userRight: webMI.query["right"],
		editable: true
	};

	if (typeof rightsHandling === "function")
		rightsHandling(rightsHandlingProperties);

	if (typeof updateRunTimeNodeConfig === "function") {
		updateRunTimeNodeConfig(runTimeNodeConfig, notifierConfig.rights, initialize);
	} else {
		initialize(runTimeNodeConfig)
	}
}


/**
 * FUNCTIONS
 */

function initialize(nodeCfg) {
	if (alarmAddress != "")
		updateAlarmIndication(alarmAddress);

	/** check if address exists **/
	var hasAddress = false;

	if (webMI.query["gatviseOptions_configNode"]) {
		hasAddress = true;
	} else for (var s = 1; s < 16; s++) {
		var seriesAddress = "series" + s + "series_address";
		if (webMI.query[seriesAddress]) {
			hasAddress = true;
		} else {
			break;
		}
	}

	/** set inactive if no address is available **/
	if (!hasAddress) {
		setInactiveLayout();
	}

	if (enableElementID) {
		try {
			var frame = webMI.rootWindow.document.getElementById(contentFrame);
			var element = frame.contentDocument.getElementById(enableElementID);

			if (!element) {
				setInactiveLayout();
			}
		} catch (ex) {
			setInactiveLayout();
		}
	}
}

/**
 * Activate display
 */
function setActiveLayout() {
	var chartDiv = document.getElementById(CHART_ID + HIGHCHARTS_CONTAINER_SUFFIX);
	chartDiv.style.visibility = "visible";

	webMI.gfx.setText(TITLE_ID, webMI.query["title"]);

	webMI.gfx.setVisible(MAIN_LABEL_ID, false);
	webMI.gfx.setVisible(SUB_LABEL_ID, false);
	webMI.gfx.setStroke(BLINKING_FRAME_ID, null);
	webMI.gfx.setFill(BACKGROUND_ID, backgroundColor);
	webMI.gfx.setFill(BLINKING_FRAME_ID, BLINKING_FRAME_COLOR_ACTIVE);

	enableClick = webMI.query["enableClick"] == "true" ? true : false;
	enableClickContent = webMI.query["enableClickContent"] == "true" ? true : false;
	enableElementID = webMI.query["linkedElementID"];
}

/**
 * Deactivate display
 */
function setInactiveLayout() {
	var chartDiv = document.getElementById(CHART_ID + HIGHCHARTS_CONTAINER_SUFFIX);
	chartDiv.style.visibility = "hidden";

	// webMI.gfx.setText(TITLE_ID, webMI.query["title"] + " (T{inactive})");
	webMI.gfx.setText(TITLE_ID, webMI.query["title"]);

	webMI.gfx.setVisible(MAIN_LABEL_ID, false);
	webMI.gfx.setVisible(SUB_LABEL_ID, false);
	webMI.gfx.setFill(BACKGROUND_ID, colorInactive);
	webMI.gfx.setFill(BLINKING_FRAME_ID, colorInactive);
	webMI.gfx.setStroke(BLINKING_FRAME_ID, BLINKING_FRAME_COLOR_INACTIVE);

	enableClick = false;
	enableClickContent = false;
	enableElementID = false;
}


/**
 * EVENT SECTION
 */

if (display && enableClick) {
	webMI.addEvent(TITLEAREA_ID, ["click", "touchend"], function (e) {
		webMI.display.openDisplay(display);
	});
}

if (display && enableClickContent) {
	webMI.addEvent(CLICKAREA_ID, ["click", "touchend"], function (e) {
		webMI.display.openDisplay(display);
	});
}

if (enableElementID) {
	var frame = webMI.rootWindow.document.getElementById(contentFrame);
	var element = frame.contentDocument.getElementById(enableElementID);
	webMI.addEvent(element, ["click", "touchend"], function (e) {
		if (display && enableClick) {
			webMI.display.openDisplay(display);
		}
	});
}

]]></code>
</script>