<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<svg height="890" version="1.2" width="1920" xmlns="http://www.w3.org/2000/svg" xmlns:atv="http://webmi.atvise.com/2007/svgext" xmlns:xlink="http://www.w3.org/1999/xlink">
 <defs/>
 <metadata>
  <atv:gridconfig enabled="false" gridstyle="lines" height="20" width="20"/>
  <atv:snapconfig enabled="true" height="5" width="5"/>
 </metadata>
 <svg atv:refpx="484.534" atv:refpy="315.312" height="600" id="topologia" transform="matrix(1.2,0,0,1.4833,0,0)" width="800" x="0" xlink:href="SYSTEM.LIBRARY.ATVISE.OBJECTDISPLAYS.Advanced.hmi.iframe" y="0">
  <atv:argument name="display" value="SYSTEM.LIBRARY.PROJECT.OBJECTDISPLAYS.Layouts_SCADA.Cuencas.Cuenca_LOX"/>
  <atv:argument name="isNavigationFrame" value="true"/>
  <atv:argument name="frameName" value="topologia"/>
 </svg>
 <foreignObject height="890" id="mapa" width="960" x="960" y="0">
  <div style="width:100%;height:100%" xmlns="http://www.w3.org/1999/xhtml"/>
 </foreignObject>
 <script atv:desc="" atv:name="" type="text/ecmascript"><![CDATA[//----------------Inicializo variables -------------------//


//Variable interna
var Info_Windowact=false;
var Markeract=false;
var Markeractdc;
var Markers= new Array();
var Rutas= new Array();
var Pos_origen;
var Pos_destination;
var WayPoints = new Array();

var google = webMI.rootWindow.google; //Clase Principal
var map; //Variable donde va a vivir el mapa
var m,n;
var circuito =
	[[21.181190741747866, -86.82976534895596],				
	 [21.181404786054, -86.82966308628907],
	 [21.182277177023106, -86.8096049363872],	
	 [21.192133032024543, -86.80655706909526],	 
	 [21.18337488197055, -86.81917943245695],	 	 
	 [21.16798636130968, -86.83129570132957],	 	 
	 [21.16321775348134, -86.86816206867053],	 	 
	 [21.166604216682753, -86.8630573852225],	 	 
	 [21.17036532798807, -86.85461216945451],	 	  
	 [21.176612190150447, -86.84130400005856],	 	 
	 [21.17335189451399, -86.84670395636395]]

					
var circuito_s =
	[[{lat:21.15970954418565, lng:-86.87467294699474},
	"Cárcamo 7 Reg 100, Agua Residual",
	"AGENT.OBJECTS.SCADA.Benito_Juarez.Cuencas.Cuenca_CAR_LOX.Carcamo_7_NH_Reg_100",
	1, "carcamoAR"],
	[{lat:21.15209260030869, lng:-86.86656509674852},
	"Cárcamo Benito Juárez, Agua Residual",
	"AGENT.OBJECTS.SCADA.Benito_Juarez.Cuencas.Cuenca_CAR_LOX.Carcamo_Benito_Juarez",
	2, "carcamoAR"],
	[{lat:21.15330542688348, lng:-86.86340112231683},
	"Cárcamo Morelos II, Agua Residual",
	"AGENT.OBJECTS.SCADA.Benito_Juarez.Cuencas.Cuenca_CAR_LOX.Carcamo_Morelos_II",
	3, "carcamoAR"],
	[{lat:21.192133032024543, lng:-86.80655706909526},
	"Cárcamo Playa Blanca, Agua Residual",
	"AGENT.OBJECTS.SCADA.Benito_Juarez.Cuencas.Cuenca_CAR_LOX.Carcamo_Morelos_I",
	4, "carcamoAR"],
	[{lat:21.155369969515444, lng:-86.85330311976696},
	"Cárcamo Tikal, Agua Residual",
	"AGENT.OBJECTS.SCADA.Benito_Juarez.Cuencas.Cuenca_CAR_LOX.Carcamo_Tikal",
	5, "carcamoAR"],
	[{lat:21.154005429829034, lng:-86.85036016155293},
	"Cárcamo Almendros, Agua Residual",
	"AGENT.OBJECTS.SCADA.Benito_Juarez.Cuencas.Cuenca_CAR_LOX.Carcamo_Almendros",
	6, "carcamoAR"],
	[{lat:21.157501255342627, lng:-86.84086874752641},
	"Cárcamo La Costa, Agua Residual",
	"AGENT.OBJECTS.SCADA.Benito_Juarez.Cuencas.Cuenca_CAR_LOX.Carcamo_La_Costa",
	7, "carcamoAR"],
	[{lat:21.163301888902176, lng:-86.83456625532449},
	"Cárcamo Plaza Bonita, Agua Residual",
	"AGENT.OBJECTS.SCADA.Benito_Juarez.Cuencas.Cuenca_CAR_LOX.Carcamo_Plaza_Bonita",
	8, "carcamoAR"],
	[{lat:21.150676088540642, lng:-86.82148167531882},
	"Cárcamo Plaza de Toros, Agua Residual",
	"AGENT.OBJECTS.SCADA.Benito_Juarez.Cuencas.Cuenca_CAR_LOX.Carcamo_Plaza_de_Toros",
	9, "carcamoAR"],
	[{lat:21.147545715715925, lng:-86.82719024136924},
	"Cárcamo SM 15, Agua Residual",
	"AGENT.OBJECTS.SCADA.Benito_Juarez.Cuencas.Cuenca_CAR_LOX.Carcamo_Farayon_SM_15",
	10, "carcamoAR"],
	[{lat:21.16365638839225, lng:-86.82116543024313},
	"Cárcamo Bonampak, Agua Residual",
	"AGENT.OBJECTS.SCADA.Benito_Juarez.Cuencas.Cuenca_CAR_LOX.Carcamo_Bonampak",
	11, "carcamoAR"],
	[{lat:21.148686273945334, lng:-86.82295015189558},
	"Cárcamo Plaza Las Américas, Agua Residual",
	"AGENT.OBJECTS.SCADA.Benito_Juarez.Cuencas.Cuenca_CAR_LOX.Carcamo_Plaza_Las_Americas",
	12, "carcamoAR"],
	[{lat:21.180396322465846, lng:-86.81465076095114},
	"Cárcamo Lombardo, Agua Residual",
	"AGENT.OBJECTS.SCADA.Benito_Juarez.Cuencas.Cuenca_CAR_LOX.Carcamo_Lombardo",
	12, "carcamoAR"],
	[{lat:21.1757001104316, lng:-86.81715743095842},
	"Cárcamo Donceles, Agua Residual",
	"AGENT.OBJECTS.SCADA.Benito_Juarez.Cuencas.Cuenca_CAR_LOX.Carcamo_Donceles",
	12, "carcamoAR"],
	[{lat:21.174350762579195, lng:-86.82033902707266},
	"Cárcamo FOVISSSTE 64, Agua Residual",
	"AGENT.OBJECTS.SCADA.Benito_Juarez.Cuencas.Cuenca_CAR_LOX.Carcamo_FOVISSSTE_64",
	12, "carcamoAR"],
	[{lat:21.15073464284999, lng:-86.82121139871262},
	"Cárcamo 6 Reg 91, Agua Residual",
	"AGENT.OBJECTS.SCADA.Benito_Juarez.Cuencas.Cuenca_CAR_LOX.Carcamo_El_Table",
	12, "carcamoAR"]];
					
var infowindow;					
var circuito_centro;
var carcamoAR = "/icons/carcamo_ar_30_18px.png";



//----------------Ejecución -------------------//



//Determinación del dispositivo
var infoCliente;
infoCliente = new webMI.getClientInfo();

//Preprocesamiento de variables

//Calculo del Centro
var suma=[0,0];
for (var i=0; i<circuito.length; i++){
	suma[0]=suma[0]+circuito[i][0]; //Latitud 
	suma[1]=suma[1]+circuito[i][1]; //Longitud
}

circuito_centro=[suma[0]/circuito.length,suma[1]/circuito.length];


webMI.addOnload(function() {
	
	//Posiciones en el mapa
	var position1 = new google.maps.LatLng(circuito_centro[0], circuito_centro[1]);
	
	//Opciones del mapa
	var myOptions = {
		zoom: 13,
		center: position1,
		mapTypeId: google.maps.MapTypeId.roadmap
	};
	

	//Inicializo el mapa
	map = new google.maps.Map(document.getElementById("mapa"), myOptions);
	
	
		
	
		
	// Instantiate an info window to hold step text.
	const stepDisplay = new google.maps.InfoWindow();
	
	
	//-------Inicializo Marcadores
	
	circuito_s.forEach(([position,title,object,order,type],i) =>{
	if (type == 'ptar') {
	carcamoAR = "/icons/planta.png"
	}
	
	
		const marker = new google.maps.Marker({
			position, 
			map,
			icon: carcamoAR,
			title: ` ${order}`,
			optimized: false,
		});
		
		marker.setMap(map);
		
		//Agrego marcador a lista de marcadores
		Markers.push(marker);
	
		//-------Listener de Marcadores
		
			//DOBLECLICK (Fija Carcamo)
		google.maps.event.addListener(marker,'dblclick',function(event) {
					
		

			webMI.display.openWindow({display:"SYSTEM.DISPLAYS.Circuito.Eslabon_AR",
			extern:false,height:610,menubar:false,modal:false,movable:true,
			resizable:true,scrollbars:false,status:false,title:title,
			toolbar:false,width:600,x:0,y:50,query:{base:   object}});

			map.panTo(this.getPosition());
			map.setZoom(15);

			Markeract=true;
			Markeractdc=marker;
			Pos_origen=position;
		
			
			//Limpio
			Elimina_Ruta(Rutas);
				
		});
			
		
		//MOUSEOVER
		google.maps.event.addListener(marker, "mouseover", function(event){
			infowindow = new google.maps.InfoWindow();
			//Abro marcador
			infowindow.open(marker.getMap,marker);
			Info_Windowact=true;
			//Defino que objeto va a ser el seleccionado para mostrar su información
			webMI.data.subscribe( object +".level_percent",
			function(e){
				infowindow.setContent(title+" - Nivel: " +
				e.value.toFixed(2) + "%");
				}
			);
			
				//infowindow.setContent(title);
		
		});	
		
		//MOUSEOUT
		google.maps.event.addListener(marker, "mouseout", function(event){
			
			
			if (Info_Windowact){
				infowindow.close();
				Info_Windowact=false;
			}			
		});
		
		
		
	});	
			
});



function Dibuja_Ruta(Origen,Destination){
	
	if(Markeract && (Origen!=Destination)){
			
		//////////// Servicios Rutas en el mapa
		var directionsService = new google.maps.DirectionsService();
		var directionsRenderer = new google.maps.DirectionsRenderer({ map: map });		
		
		//Crea el request
		var request = {
			origin: Origen,
			destination:Destination,
			travelMode: google.maps.TravelMode.DRIVING // Puedes ajustar el modo de transporte según tus necesidades
		  };    
		
		
		directionsService.route(request, function(response, status) {
			if (status == google.maps.DirectionsStatus.OK) {
			  directionsRenderer.setDirections(response);
			  Rutas.push(directionsRenderer);
			}
		  });
	 }
    
 }


function Elimina_Ruta(Rutas){
	
	Rutas.forEach(function(ruta) {
		ruta.setMap(null);
	});
	
	Rutas=new Array();
    
 }
]]></script>
</svg>
